<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Create:Ponder</title>
  <style>body{margin: 0;} canvas{position: fixed;filter: contrast(1.6);}</style>
  <link rel="stylesheet" href="styles.css" />
  <link rel="icon" href="./assets/page/Dragon_Head_JE1_BE1.png">
  <style>
    .load {
      z-index: 100;
      background-color: #d10000;
      opacity: 1;
      transition: opacity 1s ease-in-out;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }
    .loadstate {
      width: 65%;
      margin-top: .6rem;
      padding: .4rem 10px 5px 10px;
      font-weight: bolder;
      transition: all 0.5s ease-in-out;
    }
    .loadinfo {
      color: white;
      font-size: 18px;
    }
    .loadstate .rangebox {
      height: 16px;
      border: 3px solid white;
      margin-top: 5px;
      padding: 3px;
    }
    .loadstate .rangeblock {
      transition: width 0.5s ease-in-out;
      width: 0%;
      height: 100%;
      background-color: white;
    }
    .bugjump {
      width: 70%;
      margin-bottom: 1rem;
    }
  </style>
  <script type="importmap">
      {
          "imports": {
              "three": "https://jsd.onmicrosoft.cn/npm/three@0.174.0/build/three.module.min.js",
              "three/addons/": "https://jsd.onmicrosoft.cn/npm/three@0.174.0/examples/jsm/"
          }
      }
  </script>
</head>
<body>
  <section class="load abso"><img class="bugjump" src="./assets/page/bugjump.png" alt="BUGJUMP"></img></section>
  <audio id="Playmusic"></audio>
  <section id="app">
    <main id="title" class="unselectable">
      <div style="position: relative;">
        <img class="logo" src="./assets/page/logo.png" alt="logo"/>
        <span class="ooops"><a href="https://github.com/Domdkw/MC-Panorama">https://github.com/Domdkw/MC-Panorama</a></span>
      </div>
      <div class="btn-area">
        <div class="all">
          <button id="create" onclick="create()"><span class="goggles"></span>机械动力：思索</button>
          <button id="server" onclick="server(true)">服务器</button>
          <button id="options" onclick="options.show();">选项</button>
        </div>
        <div class="half">
          <button id="home_page" onclick="cd('https\:\/\/github.com/Domdkw/MC-Panorama', 'GitHub开源地址')">主页</button>
          <div class="sound_range_div">
            <div>            
              <span id="bg_music_text">音乐：</span>
              <span id="sound_state">off</span></di>
            </div>
            <input type="range" id="volume_slider" min="0" max="1" step="0.01" value="0">
          </div>
          <button id="lang_btn" title="language语言" class="outside-btn" onclick="showlang()"><img src="./assets/page/icon/language.png" alt="lang-ico"></button>
          <button id="report_btn" title="report报告" class="outside-btn" onclick="cd('https\:\/\/github.com/Domdkw/MC-Panorama/issues', 'GitHub访问链接，中国大陆用户可以通过访问https\:\/\/gitee.com/Domdkw/MC-Panorama/issues来报告问题')"><img src="./assets/page/dialog/warning_button.png" alt="report-ico"></button>
        </div>
      </div>
    </main>
    <section id="lang-div" class="abso dirt unselectable">
      <span id="lang_title" class="detailed-title">选择语言</span>
      <hr class="lang-hr">
      <div class="language-list bt-scroll">
        <span id="lang-unknown">(unknown)</span>
        <span id="zh-CN">简体中文</span>
        <span id="zh-TW">繁體中文（中国台湾）</span>
        <span id="en-US">English</span>
      </div>
      <hr class="lang-hr">
      <div class="lang-btn-half">
        <button onclick="unicode()"><span id="Use_Unicode_fonts">使用Unicode字体：</span><span id="ttf-state">off</span></button>
        <button id="lang_done" onclick="hiddenlang()">完成</button>
      </div>
    </section>
    <section id="server-page" class="abso dirt">
      <div class="sv_title">服务器列表</div>
      <div class="sv-div">
        <div class="sv-list bt-scroll">
          <div class="sv-item" data-server-ip="play.simpfun.cn:19533">
            <img class="sv-title-img" src="./assets/server/lyf 2024.43.43.png" alt="服务器图片">
            <div class="sv-item-info">
              <p style="font-size: large;">lyf 2024.43.43</p>
              <p class="sv-description" style="color: #eee8;"></p>
            </div>
            <div class="sv-item-state">
              <div class="sv-item-online">
                <span class="player-state">
                </span>
                <div class="sv-state-img"></div>
              </div>
            </div>
          </div><!--card-->
          <div class="sv-item" data-server-ip="mc.catserver.moe">
            <img class="sv-title-img" src="" alt="服务器图片">
            <div class="sv-item-info">
              <p style="font-size: large;">神必猫猫</p>
              <p class="sv-description" style="color: #eee8;"></p>
            </div>
            <div class="sv-item-state">
              <div class="sv-item-online">
                <span class="player-state">
                </span>
                <div class="sv-state-img"></div>
              </div>
            </div>
          </div><!--card-->
        </div>
      </div>
      <div class="btn-area">
        <button id="sv_back" onclick="server(false)">返回</button>
        <button id="sv_refresh" onclick="refreshsv()">刷新</button>
        <button id="copy_svlink">复制链接地址</button>
        <button id="sv_det">详细信息</button>
      </div>
    </section>
    <section id="options-page" class="abso dirt unselectable">
      <div class="tab-container">
        <button class="tab active canClick" onclick="options.subPage('General')">通用</button>
        <button class="tab canClick" onclick="options.subPage('Browser')">浏览器信息</button>
        <button class="tab done canClick" onclick="options.hide();options.save()">完成</button>
      </div>
      <div class="setting-main">
        <div class="settings-container bt-scroll">
          <div class="setting-div General show">
            <div id="sti-imgMirror" class="setting-item select" data-type="select">
              <span class="setting-label">全景图镜像源</span>
              <select name="imgMirror-source">
                <option value="local" selected>本地</option>
                <option value="jsDeliver" disabled>jsDeliver</option>
              </select>
            </div>
            <div id="sti-moreooops" class="setting-item checkbox" data-type="checkbox">
                <span class="setting-label">启用更多ooops信息</span>
                <label class="canClick"><input class="canClick" type="checkbox"></label>
            </div>
            <div id="sti-ooops-source" class="setting-item chd disabled" data-type="select">
              <span class="setting-label">--ooops信息来源</span>
              <span class="setting-remind"></span>
              <select name="ooops-source" disabled>
                <option value="local" selected>本地</option>
              </select>
            </div>
          </div>
          <div class="setting-div Browser">
            <div class="sti-LS-div setting-child sti-LS-info-sti">
              <button class="sti-LS-info-btn tab canClick" onclick="options.btn.showLSInfoSti()">查看LocalStorage.sti</button>
            </div>
            <div class="sti-LS-div setting-child sti-LS-info-all">
              <button class="sti-LS-info-btn tab canClick" onclick="options.btn.showLSInfoAll()">查看所有LocalStorage</button>
            </div>
            <div class="sti-LS-div setting-child sti-LS-clean-sti">
              <button class="sti-LS-info-btn tab canClick" onclick="options.btn.cleanLS()">清除LocalStorage.sti</button>
            </div>
            <div class="sti-LS-div setting-child sti-LS-clean-all">
              <button class="sti-LS-info-btn tab canClick" onclick="options.btn.cleanAllLS()">清除所有LocalStorage</button>
            </div>
            <hr>
            <style>#service-provider>*{margin:2rem}</style>
            <div id="service-provider" style="display:flex;flex-wrap:wrap;justify-content:space-evenly;align-items:center;min-height:10rem;">
              <button onclick="document.getElementById('service-provider').innerHTML=service_provider">服务提供商</button>
            </div>
          </div>
        </div>
      </div>
    </section>  
  </section>
  <section id="cd-page" class="abso dirt">
    <div class="cd-main">
      <div class="cd-title">
        <span id="cd_text_info">这指向一个网页链接，不能确定其安全性，是否进行跳转？</span>
        <a id="cd_text_link" style="color: #2530ff;"></a>
      </div>
      <div class="cd-buttons">
        <button id="openurl">打开此网站</button>
        <button id="urlcopy">复制到剪贴板</button>
        <button id="urlcancel" onclick="cd(false)">取消</button>
      </div>
    </div>
  </section>
  <section id="option-LS" class="abso dirt unselectable">
    <div class="oLA-container">
      <div class="oLA-info">
        <div id="oLA-text"></div>
      </div>
      <div class="oLA-btn-area">
        <button id="oLA-cancel-Btn">取消</button>
        <button id="oLA-accept-Btn">启用</button>
      </div>
    </div>
  </section>
  <section id="terminal"></section>
  <script>
    //api
    const navLang = navigator.language;
    const body = document.body;
    const terminal = document.getElementById('terminal')
    let fileLoaded = 0;
    const loadingDiv = document.querySelector('.load');
    function SNLB(i, range){//setNewLoadBlock
      const loadstate = document.createElement('div');
      loadstate.classList.add('loadstate');
      if (range){
        loadstate.innerHTML = '<h class="loadinfo"></h><div class="rangebox"><div class="rangeblock"></div></div>';
      }else{
        loadstate.innerHTML = '<h class="loadinfo"></h>';
      }
      loadingDiv.appendChild(loadstate);
      const loadinfo = loadstate.querySelector('.loadinfo');
      const rangeblock = loadstate.querySelector('.rangeblock') || null;
      loadstate.id = i;
      return {loadstate, loadinfo, rangeblock}
    }
    function loadFile(url, type, range, title=`Loading ${url}...`){
      return new Promise((resolve, reject) => {
        try {
          const {loadstate, loadinfo, rangeblock} = SNLB(url, range);
          loadinfo.innerHTML = title;
          const xhr = new XMLHttpRequest();
          xhr.open('GET', url, true);
          xhr.setRequestHeader('Accept', 'text/plain');
          xhr.responseType = 'text';
          
          xhr.onprogress = (e) => {
            if (rangeblock && e.lengthComputable) {
              rangeblock.style.width = `${(e.loaded / e.total) * 100}%`;
            }
          }
          
          xhr.onload = () => {
            if (xhr.readyState === 4 && xhr.status === 200) {
              loadstate.style.backgroundColor = '#fff6';
              if (rangeblock) rangeblock.style.width = '100%';
              
              let data;
              switch (type) {
                case 'js':
                  // 使用Blob对象加载并执行JavaScript
                  const jsBlob = new Blob([xhr.responseText], { type: 'application/javascript' });
                  const jsUrl = URL.createObjectURL(jsBlob);
                  const script = document.createElement('script');
                  script.src = jsUrl;
                  script.onload = function() {
                    URL.revokeObjectURL(jsUrl); // 释放Blob URL
                    data = undefined;
                    resolve(data);
                  };
                  script.onerror = function() {
                    URL.revokeObjectURL(jsUrl); // 释放Blob URL
                    loadinfo.textContent = `Failed to execute ${url}!`;
                    reject(new Error(`Failed to execute ${url}`));
                  };
                  document.body.appendChild(script);
                  return; // 不立即resolve，等待脚本加载完成
                  
                case 'css':
                  // 使用Blob对象加载并应用CSS
                  const cssBlob = new Blob([xhr.responseText], { type: 'text/css' });
                  const cssUrl = URL.createObjectURL(cssBlob);
                  const link = document.createElement('link');
                  link.rel = 'stylesheet';
                  link.href = cssUrl;
                  link.onload = function() {
                    URL.revokeObjectURL(cssUrl); // 释放Blob URL
                    data = undefined;
                    resolve(data);
                  };
                  link.onerror = function() {
                    URL.revokeObjectURL(cssUrl); // 释放Blob URL
                    loadinfo.textContent = `Failed to load CSS ${url}!`;
                    reject(new Error(`Failed to load CSS ${url}`));
                  };
                  document.head.appendChild(link);
                  return; // 不立即resolve，等待CSS加载完成
                  
                case 'json':
                  try {
                    data = JSON.parse(xhr.responseText);
                  } catch (jsonError) {
                    loadinfo.textContent = `Failed to parse JSON from ${url}!`;
                    reject(new Error(`Failed to parse JSON from ${url}: ${jsonError.message}`));
                    return;
                  }
                  break;
                  
                default:
                  data = xhr.responseText;
                  break;
              }
              resolve(data);
            } else {
              loadinfo.textContent = `Failed to load ${url}! Status: ${xhr.status}`;
              reject(new Error(`Failed to load ${url}. Status: ${xhr.status}`));
            }
          }
          
          xhr.onerror = () => {
            loadinfo.textContent = `Failed to load ${url}! Network error`;
            reject(new Error(`Network error while loading ${url}`));
          }
          
          xhr.ontimeout = () => {
            loadinfo.textContent = `Failed to load ${url}! Request timeout`;
            reject(new Error(`Request timeout while loading ${url}`));
          }
          
          xhr.send();
        } catch (error) {
          reject(new Error(`Unexpected error in loadFile: ${error.message}`));
        }
      });
    }
    let sound_enable = false;
    document.querySelector('.sound_range_div').addEventListener('click', ()=>{//侦听点击
      if (sound_enable) return;
      sound_enable = true;
      document.getElementById('sound_state').textContent = 'Loading';
      terminal.innerHTML = '加载音乐脚本文件(playsound.js)';
      const script = document.createElement('script');
      script.src = './playsound.js';
      document.body.appendChild(script);
    })
    const service_provider = '<a href="https://www.netlify.com"><img src="https://www.netlify.com/assets/badges/netlify-badge-color-accent.svg" alt="Deploys by Netlify" /></a><a class="badge" href="https://www.jsdelivr.com/package/npm/three" title="jsDelivr monthly hits"><img alt="jsDelivr 每月点击徽章" src="https://data.jsdelivr.com/v1/package/npm/three/badge"></a><a class="main-logo" href="https://www.jsdelivr.com" title="jsDelivr"><img width="140" height="34" title="jsDelivr" src="https://www.jsdelivr.com/assets/f14dc4533f22bdb854b88e243bdbaa447249ae7a/img/jsdelivr-horizontal-regular.svg"></a><br><img alt="GitHub commit activity" src="https://img.shields.io/github/commit-activity/t/Domdkw/MC-Panorama"><img alt="GitHub last commit" src="https://img.shields.io/github/last-commit/Domdkw/MC-Panorama"><img alt="GitHub License" src="https://img.shields.io/github/license/Domdkw/MC-Panorama">';
  </script>
  <script type="module">
    async function loadTHREE() {
      loadFile('page.js', 'js', true, '加载必要界面脚本<span class="file-tag y ml">page.js</span>')
      const {loadstate, loadinfo, rangeblock} = SNLB('three', true);
      loadinfo.innerHTML = 'Loading the <span class="file-tag y">three@0.174.0.js</span> module...';
      const module = await import('three');
      try {
        window.THREE = module;
        loadinfo.innerHTML = 'The <span class="file-tag y">three@0.174.0.js</span> module is loaded successfully!';
        rangeblock.style.width = '100%';
        loadstate.style.backgroundColor = '#fff6';
        //加载mc-panorama
        await loadFile('mc-background.js', 'js', true, '加载mc-panorama<span class="file-tag y ml">mc-background.js</span>')
        setTimeout(() => {
          loadMcPanorama();
          //create()
        }, 100);
      }catch (e) {
        loadinfo.textContent = 'Failed to load the three.js module!';
        rangeblock.style.width = '0%';
      }
    }
    loadTHREE();
  </script>
</body>
</html>
